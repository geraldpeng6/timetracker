# TimeTracker 排序功能修复说明

## 🐛 修复的问题

### 1. Pre-commit Hooks 复原和改进

**问题**: 之前的 pre-commit hooks 配置丢失
**解决方案**:
- 创建了 `scripts/install-hooks.sh` 脚本
- 在 `Makefile` 中添加了 `setup-hooks` 目标
- 包含以下自动检查:
  - Rust 代码格式化 (`cargo fmt`)
  - Clippy 代码质量检查
  - 单元测试

**使用方法**:
```bash
make setup-hooks
# 或直接运行
./scripts/install-hooks.sh
```

### 2. 排序功能 (s键) 修复

**问题**: 在窗口视图中，按 's' 键排序功能不正常
**原因**: `cycle_sort()` 函数中缺少对 `SortBy::WindowTitle` 的正确处理
**解决方案**:
- 修复了 `cycle_sort()` 函数，正确处理窗口视图的排序字段切换
- 在窗口视图中，排序字段在 `Duration` 和 `WindowTitle` 之间切换
- 添加了选择状态重置，避免索引越界

### 3. 倒序功能 (r键) 修复

**问题**: 按 'r' 键切换排序顺序时可能出现问题
**解决方案**:
- 修复了 `reverse_sort()` 函数
- 添加了选择状态重置，确保排序顺序切换后界面正常显示

### 4. 窗口闪动问题修复

**问题**: 当应用窗口时间相同时，它们的顺序会一直改变，导致界面闪动
**原因**: 排序算法不稳定，相同时间的项目排序不一致
**解决方案**:
- 在所有排序比较中添加了多级排序条件:
  1. 主要排序字段 (时间或名称)
  2. 次要排序字段 (时间相同时按名称排序，名称相同时按时间排序)
  3. 原始索引 (确保稳定排序)

**具体修复**:
```rust
// 修复前 - 不稳定排序
b.item.1.cmp(a.item.1)
    .then_with(|| a.original_index.cmp(&b.original_index))

// 修复后 - 稳定排序
b.item.1.cmp(a.item.1)
    .then_with(|| a.item.0.cmp(b.item.0)) // 时间相同时按名称排序
    .then_with(|| a.original_index.cmp(&b.original_index))
```

## 🔧 技术细节

### 排序稳定性改进

1. **应用程序表格**:
   - 按时间排序时，时间相同的应用按名称排序
   - 按名称排序时，名称相同的应用按时间排序

2. **窗口表格**:
   - 支持按窗口标题排序 (`SortBy::WindowTitle`)
   - 按时间排序时，时间相同的窗口按名称排序
   - 按名称排序时，名称相同的窗口按时间排序

3. **最近活动表格**:
   - 保持原有的排序逻辑
   - 增强了排序稳定性

### 用户界面改进

- 修复了窗口表格标题显示，正确显示 "窗口名称" 而不是 "应用名称"
- 排序指示器 (↑↓) 正确显示当前排序顺序
- 选择状态在排序切换时正确重置

## 🧪 测试方法

运行测试脚本:
```bash
./test_sorting.sh
```

手动测试步骤:
1. 启动 TUI: `timetracker tui`
2. 按 '2' 切换到数据分析页面
3. 按 'v' 切换视图模式
4. 按 's' 测试排序字段切换
5. 按 'r' 测试排序顺序切换
6. 观察是否还有闪动现象

## 📝 快捷键说明

- `s`: 循环切换排序字段
- `r`: 切换排序顺序 (升序/降序)
- `v`: 切换视图模式 (应用程序/窗口/最近活动)
- `1/2/3`: 切换标签页
- `h` 或 `F1`: 显示帮助

## ✅ 验证清单

- [ ] Pre-commit hooks 正常安装和运行
- [ ] 应用程序视图排序功能正常
- [ ] 窗口视图排序功能正常 (包括 WindowTitle 排序)
- [ ] 最近活动视图排序功能正常
- [ ] 相同时间的项目不再闪动
- [ ] 排序指示器正确显示
- [ ] 表格标题正确显示排序状态